<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>経験ロールチェックリスト</title>
    <style>
        /* --- 全体のスタイル --- */
        body { font-family: sans-serif; max-width: 700px; margin: 20px auto; background-color: #f0f0f0; padding-bottom: 20px; }
        .header { display: flex; justify-content: center; align-items: center; position: relative; gap: 10px; }
        h1 { text-align: center; color: #333; margin: 20px 0; }

        /* --- ボタンのスタイル --- */
        #mode-toggle-button, #layout-toggle-button {
            display: none; /* 基本は非表示 */
            background-color: #555; color: white; border: none;
            padding: 8px 12px; border-radius: 4px; cursor: pointer; white-space: nowrap;
        }

        /* --- タブのスタイル --- */
        .tab-buttons { overflow: hidden; border-bottom: 2px solid #ccc; background: white; }
        .tab-buttons button.tab-link { background-color: #f1f1f1; float: left; border: none; outline: none; cursor: pointer; padding: 10px 15px; font-size: 16px; transition: 0.3s; display: flex; align-items: center; justify-content: space-between; }
        .tab-buttons button.tab-link:hover { background-color: #ddd; }
        .tab-buttons button.tab-link.active { background-color: #ccc; font-weight: bold; }
        .char-name { padding-right: 10px; white-space: nowrap; }
        .char-name:hover { background-color: #ffecb3; cursor: pointer; border-radius: 3px; }
        .delete-tab-button { background: #ccc; color: #555; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 14px; line-height: 20px; text-align: center; cursor: pointer; transition: 0.2s; flex-shrink: 0; }
        .delete-tab-button:hover { background: #f44336; color: white; }
        #add-tab-button { background-color: #a0cda0; float: left; border: none; cursor: pointer; padding: 10px 15px; font-weight: bold; font-size: 20px; border-radius: 5px 5px 0 0; }
        #add-tab-button:hover { background-color: #8bc38b; }

        /* --- キャラクターシートのスタイル --- */
        .tab-content { display: none; padding: 20px; border-top: none; background-color: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .tab-content h2 { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #666; padding-bottom: 5px; margin-top: 0; }
        .reset-button { background-color: #f44336; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; white-space: nowrap; }
        .reset-button:hover { background-color: #d32f2f; }
        
        /* --- 技能カテゴリのスタイル --- */
        .skill-category { margin-bottom: 20px; }
        .skill-category h3 { margin: 0 0 10px 0; padding-bottom: 5px; border-bottom: 1px dashed #ccc; font-size: 18px; }
        .skill-list { list-style: none; padding-left: 0; margin: 0; }
        .skill-list li { padding: 8px 5px; border-bottom: 1px solid #eee; display: flex; align-items: center; }
        .skill-list li:last-child { border-bottom: none; }
        .skill-list label { display: flex; align-items: center; flex-grow: 1; cursor: pointer; }
        .skill-list input[type="checkbox"] { margin-right: 10px; }
        
        /* --- 特殊な技能欄のスタイル --- */
        .critical-counter { width: 40px; text-align: right; margin-right: 8px; flex-shrink: 0; }
        .growth-input { width: 50px; text-align: right; }
        .skill-specialization { border: 1px solid #ccc; padding: 4px; margin-left: 8px; width: 100px; }
        .custom-skill-input { border: 1px solid #ccc; padding: 4px; flex-grow: 1; margin-right: 10px; min-width: 50px; }
        .add-skill-button { padding: 2px 8px; font-weight: bold; cursor: pointer; border: 1px solid #ccc; background: #f0f0f0; }

        /* --- メモ欄のスタイル --- */
        .memo-area { width: 100%; height: 100px; padding: 10px; box-sizing: border-box; border: 1px solid #ccc; resize: vertical; font-size: 14px; }

        /* --- サマリー出力欄のスタイル --- */
        .summary-section { margin-top: 30px; padding: 20px; background-color: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .summary-header { display: flex; justify-content: space-between; align-items: center; }
        #summary-output { width: 100%; height: 250px; margin-top: 10px; font-family: monospace; font-size: 14px; white-space: pre-wrap; }
        #copy-summary-button { background-color: #1E88E5; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; }
        #copy-summary-button:hover { background-color: #1565C0; }

        /* --- スマホ用のスタイル --- */
        @media (max-width: 799px) {
            body { margin: 0; padding: 10px; }
            h1 { font-size: 24px; }
            .header { flex-direction: column; gap: 0; }
            .tab-buttons { overflow-x: auto; white-space: nowrap; -webkit-overflow-scrolling: touch; }
            .tab-buttons button.tab-link, #add-tab-button { float: none; display: inline-block; }
            .tab-content, .summary-section { padding: 15px; }
            h2 { font-size: 20px; }
        }
        
        /* --- PCなどの広い画面用の基本スタイル --- */
        @media (min-width: 800px) {
            body { max-width: 95%; }
            #mode-toggle-button { display: inline-block; }
        }

        /* --- ワイドモードがONの時のスタイル --- */
        body.wide-mode-on #layout-toggle-button { display: inline-block; }
        body.wide-mode-on .tab-content { display: block !important; border-top: 1px solid #ccc; }
        body.wide-mode-on .summary-section { display: none; }
        
        /* ワイドモードのデフォルト（横スクロール表示） */
        body.wide-mode-on #sheets-container {
            display: grid;
            grid-auto-flow: column;
            grid-auto-columns: 360px;
            gap: 20px;
            overflow-x: auto;
            padding-bottom: 15px;
        }
        
        /* ワイドモードでフィット表示がONの時 */
        body.wide-mode-on.fit-mode-on #sheets-container {
            grid-auto-flow: row;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            overflow-x: hidden;
        }
    </style>
</head>
<body>

    <div class="header">
        <h1>経験ロールチェックリスト</h1>
        <div>
            <button id="mode-toggle-button">ワイドモードに切り替え</button>
            <button id="layout-toggle-button">ウィンドウ幅に合わせる</button>
        </div>
    </div>

    <div class="tab-buttons">
        <button class="tab-link active" onclick="openCharSheet(event, 'char1')">
            <span class="char-name" data-char-id="char1">探索者1</span>
            <button class="delete-tab-button">×</button>
        </button>
        <button id="add-tab-button">+</button>
    </div>

    <div id="sheets-container">
        <div id="char1" class="tab-content" style="display: block;"></div>
    </div>

    <div class="summary-section">
        <div class="summary-header">
            <h2>サマリー出力</h2>
            <button id="copy-summary-button">クリップボードにコピー</button>
        </div>
        <textarea id="summary-output" readonly placeholder="ここに現在開いている探索者のサマリーが表示されます"></textarea>
    </div>

    <template id="sheet-template"></template>

    <script>
        let charCount = 1;

        function toggleWideMode() {
            const body = document.body;
            const button = document.getElementById('mode-toggle-button');
            const layoutButton = document.getElementById('layout-toggle-button');
            body.classList.toggle('wide-mode-on');

            if (body.classList.contains('wide-mode-on')) {
                button.textContent = '通常表示に戻す';
            } else {
                button.textContent = 'ワイドモードに切り替え';
                body.classList.remove('fit-mode-on');
                // ▼▼▼ ボタン名を修正 ▼▼▼
                layoutButton.textContent = 'ウィンドウ幅に合わせる';
                document.querySelector('.tab-link.active').click();
            }
        }

        function toggleLayoutMode() {
            const body = document.body;
            const button = document.getElementById('layout-toggle-button');
            body.classList.toggle('fit-mode-on');

            if (body.classList.contains('fit-mode-on')) {
                button.textContent = 'スクロール表示に切り替え';
            } else {
                // ▼▼▼ ボタン名を修正 ▼▼▼
                button.textContent = 'ウィンドウ幅に合わせる';
            }
        }

        // (↓これより下の他のJavaScript関数は変更ありません)

        function openCharSheet(evt, charId) {
            if (evt.target.classList.contains('delete-tab-button')) return;
            document.querySelectorAll('.tab-content').forEach(tc => tc.style.display = 'none');
            document.querySelectorAll('.tab-link').forEach(tl => tl.classList.remove('active'));
            document.getElementById(charId).style.display = 'block';
            evt.currentTarget.classList.add('active');
            updateSummary();
        }

        function addCharSheet() {
            charCount++;
            const newCharId = 'char' + charCount;
            const newCharName = '探索者' + charCount;
            const newButton = document.createElement('button');
            newButton.className = 'tab-link';
            newButton.onclick = (event) => openCharSheet(event, newCharId);
            newButton.innerHTML = `<span class="char-name" data-char-id="${newCharId}">${newCharName}</span><button class="delete-tab-button">×</button>`;
            const newSheet = document.createElement('div');
            newSheet.id = newCharId;
            newSheet.className = 'tab-content';
            const template = document.getElementById('sheet-template').innerHTML;
            newSheet.innerHTML = `<h2><div><span class="char-name" data-char-id="${newCharId}">${newCharName}</span>の技能</div><button class="reset-button">リセット</button></h2>` + template;
            document.getElementById('add-tab-button').before(newButton);
            document.getElementById('sheets-container').appendChild(newSheet);
            newSheet.querySelector('.reset-button').addEventListener('click', resetSheet);
            newButton.querySelector('.delete-tab-button').addEventListener('click', deleteSheet);
            newButton.click();
        }

        function handleNameEdit(event) {
            const targetSpan = event.target;
            if (!targetSpan.classList.contains('char-name')) return;
            const originalSpan = targetSpan;
            const charId = originalSpan.dataset.charId;
            const input = document.createElement('input');
            input.type = 'text';
            input.value = originalSpan.textContent;
            originalSpan.replaceWith(input);
            input.focus();
            const saveName = () => {
                const newName = input.value.trim() || '名称未設定';
                document.querySelectorAll(`.char-name[data-char-id="${charId}"]`).forEach(span => {
                    span.textContent = newName;
                });
                input.replaceWith(originalSpan);
                updateSummary();
            };
            input.addEventListener('blur', saveName);
            input.addEventListener('keydown', (e) => { if (e.key === 'Enter') saveName(); });
        }

        function addCustomSkill(event) {
            const li = event.target.parentElement;
            const input = li.querySelector('.custom-skill-input');
            const skillName = input.value.trim();
            if (!skillName) { alert("技能名を入力してください。"); return; }
            const newLi = document.createElement('li');
            newLi.className = 'custom-skill';
            newLi.innerHTML = `<input type="number" class="critical-counter" min="0" placeholder="0"><label><input type="checkbox"> ${skillName}</label>`;
            li.before(newLi);
            input.value = "";
            updateSummary();
        }

        function resetSheet(event) {
            if (!confirm("この探索者の情報を本当にリセットしますか？")) return;
            const sheet = event.currentTarget.closest('.tab-content');
            const charId = sheet.id;
            sheet.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            sheet.querySelectorAll('input[type="number"], input[type="text"]').forEach(num => num.value = '');
            sheet.querySelector('.memo-area').value = '';
            sheet.querySelectorAll('.custom-skill').forEach(skill => skill.remove());
            const defaultName = '探索者' + charId.replace('char', '');
            document.querySelectorAll(`.char-name[data-char-id="${charId}"]`).forEach(span => span.textContent = defaultName);
            updateSummary();
        }

        function deleteSheet(event) {
            event.stopPropagation();
            if (document.querySelectorAll('.tab-link').length <= 1) { alert("最後のタブは削除できません。"); return; }
            if (!confirm("この探索者を本当に削除しますか？")) return;
            const tabButton = event.currentTarget.closest('.tab-link');
            const charId = tabButton.querySelector('.char-name').dataset.charId;
            const wasActive = tabButton.classList.contains('active');
            tabButton.remove();
            document.getElementById(charId).remove();
            if (wasActive) document.querySelector('.tab-link').click();
            else updateSummary();
        }

        function updateSummary() {
            const activeTab = document.querySelector('.tab-link.active');
            const summaryOutput = document.getElementById('summary-output');
            if (!activeTab) { summaryOutput.value = ""; return; }
            const charId = activeTab.querySelector('.char-name').dataset.charId;
            const sheet = document.getElementById(charId);
            if (!sheet) return;
            const charName = sheet.querySelector('.char-name').textContent;
            let criticalSkills = [];
            let checkedSkills = [];
            sheet.querySelectorAll('.skill-list li').forEach(li => {
                const criticalInput = li.querySelector('.critical-counter');
                const checkbox = li.querySelector('input[type="checkbox"]');
                const skillLabel = li.querySelector('label');
                if (skillLabel) {
                    let skillName = skillLabel.textContent.trim();
                    const specializationInput = li.querySelector('.skill-specialization');
                    if (specializationInput && specializationInput.value.trim() !== '') {
                        skillName += `(${specializationInput.value.trim()})`;
                    }
                    if (criticalInput && criticalInput.value > 0) criticalSkills.push(`・${skillName} : ${criticalInput.value}回`);
                    if (checkbox && checkbox.checked) checkedSkills.push(`・${skillName}`);
                }
            });
            const mythosGrowth = sheet.querySelector('.growth-input').value || '0';
            const memoContent = sheet.querySelector('.memo-area').value.trim();
            let summaryText = `■探索者名： ${charName}\n\n`;
            summaryText += '▼クリティカルした技能\n';
            summaryText += criticalSkills.length > 0 ? criticalSkills.join('\n') + '\n\n' : 'なし\n\n';
            summaryText += '▼チェックした技能（初期値成功含む）\n';
            summaryText += checkedSkills.length > 0 ? checkedSkills.join('\n') + '\n\n' : 'なし\n\n';
            summaryText += `▼クトゥルフ神話技能の成長： ${mythosGrowth}%\n\n`;
            summaryText += '▼自由メモ欄\n';
            summaryText += memoContent !== '' ? memoContent : 'なし';
            summaryOutput.value = summaryText;
        }
        
        function copySummary() {
            const summaryOutput = document.getElementById('summary-output');
            const button = document.getElementById('copy-summary-button');
            navigator.clipboard.writeText(summaryOutput.value).then(() => {
                const originalText = button.textContent;
                button.textContent = 'コピーしました！';
                setTimeout(() => { button.textContent = originalText; }, 2000);
            }, () => { alert('コピーに失敗しました。'); });
        }

        function initialize() {
            const templateHolder = document.getElementById('sheet-template');
            templateHolder.innerHTML = `
                <div class="skill-category"><h3>戦闘技能</h3><ul class="skill-list"><li><input type="number" class="critical-counter" min="0" placeholder="0"><label><input type="checkbox"> 回避</label></li><li><input type="number" class="critical-counter" min="0" placeholder="0"><label><input type="checkbox"> キック</label></li><li><input type="number" class="critical-counter" min="0" placeholder="0"><label><input type="checkbox"> 組み付き</label></li><li><input type="number" class="critical-counter" min="0" placeholder="0"><label><input type="checkbox"> こぶし（パンチ）</label></li><li><input type="number" class="critical-counter" min="0" placeholder="0"><label><input type="checkbox"> 頭突き</label></li><li><input type="number" class="critical-counter" min="0" placeholder="0"><label><input type="checkbox"> 投擲</label></li><li><input type="number" class="critical-counter" min="0" placeholder="0"><label><input type="checkbox"> マーシャルアーツ</label></li><li><input type="number" class="critical-counter" min="0" placeholder="0"><label><input type="checkbox"> 拳銃</label></li><li><input type="number" class="critical-counter" min="0" placeholder="0"><label><input type="checkbox"> サブマシンガン</label></li><li><input type="number" class="critical-counter" min="0" placeholder="0"><label><input type="checkbox"> ショットガン</label></li><li><input type="number" class="critical-counter" min="0" placeholder="0"><label><input type="checkbox"> マシンガン</label></li><li><input type="number" class="critical-counter" min="0" placeholder="0"><label><input type="checkbox"> ライフル</label></li><li><input type="text" class="custom-skill-input" placeholder="技能名を入力"><button class="add-skill-button">+</button></li></ul></div>
                <div class="skill-category"><h3>探索技能</h3><ul class="skill-list"><li><input type="number" class="critical-counter" min="0" placeholder="0"><label><input type="checkbox"> 応急手当</label></li><li><input type="number" class="critical-counter" min="0" placeholder="0"><label><input type="checkbox"> 鍵開け</label></li><li><input type="number" class="critical-counter" min="0" placeholder="0"><label><input type="checkbox"> 隠す</label></li><li><input type="number" class="critical-counter" min="0" placeholder="0"><label><input type="checkbox"> 隠れる</label></li><li><input type="number" class="critical-counter" min="0" placeholder="0"><label><input type="checkbox"> 聞き耳</label></li><li><input type="number" class="critical-counter" min="0" placeholder="0"><label><input type="checkbox"> 忍び歩き</label></li><li><input type="number" class="critical-counter" min="0" placeholder="0"><label><input type="checkbox"> 写真術</label></li><li><input type="number" class="critical-counter" min="0" placeholder="0"><label><input type="checkbox"> 精神分析</label></li><li><input type="number" class="critical-counter" min="0" placeholder="0"><label><input type="checkbox"> 追跡</label></li><li><input type="number" class="critical-counter" min="0" placeholder="0"><label><input type="checkbox"> 登攀</label></li><li><input type="number" class="critical-counter" min="0" placeholder="0"><label><input type="checkbox"> 図書館</label></li><li><input type="number" class="critical-counter" min="0" placeholder="0"><label><input type="checkbox"> 目星</label></li><li><input type="text" class="custom-skill-input" placeholder="技能名を入力"><button class="add-skill-button">+</button></li></ul></div>
                <div class="skill-category"><h3>行動技能</h3><ul class="skill-list"><li><input type="number" class="critical-counter" min="0" placeholder="0"><label><input type="checkbox"> 運転</label></li><li><input type="number" class="critical-counter" min="0" placeholder="0"><label><input type="checkbox"> 機械修理</label></li><li><input type="number" class="critical-counter" min="0" placeholder="0"><label><input type="checkbox"> 重機械操作</label></li><li><input type="number" class="critical-counter" min="0" placeholder="0"><label><input type="checkbox"> 乗馬</label></li><li><input type="number" class="critical-counter" min="0" placeholder="0"><label><input type="checkbox"> 水泳</label></li><li><input type="number" class="critical-counter" min="0" placeholder="0"><label><input type="checkbox"> 製作</label><input type="text" class="skill-specialization" placeholder="専門分野"></li><li><input type="number" class="critical-counter" min="0" placeholder="0"><label><input type="checkbox"> 操縦</label><input type="text" class="skill-specialization" placeholder="専門分野"></li><li><input type="number" class="critical-counter" min="0" placeholder="0"><label><input type="checkbox"> 跳躍</label></li><li><input type="number" class="critical-counter" min="0" placeholder="0"><label><input type="checkbox"> 電気修理</label></li><li><input type="number" class="critical-counter" min="0" placeholder="0"><label><input type="checkbox"> ナビゲート</label></li><li><input type="number" class="critical-counter" min="0" placeholder="0"><label><input type="checkbox"> 変装</label></li><li><input type="text" class="custom-skill-input" placeholder="技能名を入力"><button class="add-skill-button">+</button></li></ul></div>
                <div class="skill-category"><h3>交渉技能</h3><ul class="skill-list"><li><input type="number" class="critical-counter" min="0" placeholder="0"><label><input type="checkbox"> 言いくるめ</label></li><li><input type="number" class="critical-counter" min="0" placeholder="0"><label><input type="checkbox"> 信用</label></li><li><input type="number" class="critical-counter" min="0" placeholder="0"><label><input type="checkbox"> 説得</label></li><li><input type="number" class="critical-counter" min="0" placeholder="0"><label><input type="checkbox"> 値切り</label></li><li><input type="number" class="critical-counter" min="0" placeholder="0"><label><input type="checkbox"> 母国語</label></li><li><input type="text" class="custom-skill-input" placeholder="技能名を入力"><button class="add-skill-button">+</button></li></ul></div>
                <div class="skill-category"><h3>知識技能</h3><ul class="skill-list"><li><input type="number" class="critical-counter" min="0" placeholder="0"><label><input type="checkbox"> 医学</label></li><li><input type="number" class="critical-counter" min="0" placeholder="0"><label><input type="checkbox"> オカルト</label></li><li><input type="number" class="critical-counter" min="0" placeholder="0"><label><input type="checkbox"> 化学</label></li><li><span>クトゥルフ神話</span><div><input type="number" class="growth-input" min="0" placeholder="0">% 成長</div></li><li><input type="number" class="critical-counter" min="0" placeholder="0"><label><input type="checkbox"> 芸術</label><input type="text" class="skill-specialization" placeholder="専門分野"></li><li><input type="number" class="critical-counter" min="0" placeholder="0"><label><input type="checkbox"> 経理</label></li><li><input type="number" class="critical-counter" min="0" placeholder="0"><label><input type="checkbox"> 考古学</label></li><li><input type="number" class="critical-counter" min="0" placeholder="0"><label><input type="checkbox"> コンピューター</label></li><li><input type="number" class="critical-counter" min="0" placeholder="0"><label><input type="checkbox"> 心理学</label></li><li><input type="number" class="critical-counter" min="0" placeholder="0"><label><input type="checkbox"> 人類学</label></li><li><input type="number" class="critical-counter" min="0" placeholder="0"><label><input type="checkbox"> 生物学</label></li><li><input type="number" class="critical-counter" min="0" placeholder="0"><label><input type="checkbox"> 地質学</label></li><li><input type="number" class="critical-counter" min="0" placeholder="0"><label><input type="checkbox"> 電子工学</label></li><li><input type="number" class="critical-counter" min="0" placeholder="0"><label><input type="checkbox"> 天文学</label></li><li><input type="number" class="critical-counter" min="0" placeholder="0"><label><input type="checkbox"> 博物学</label></li><li><input type="number" class="critical-counter" min="0" placeholder="0"><label><input type="checkbox"> 物理学</label></li><li><input type="number" class="critical-counter" min="0" placeholder="0"><label><input type="checkbox"> 法律</label></li><li><input type="number" class="critical-counter" min="0" placeholder="0"><label><input type="checkbox"> 薬学</label></li><li><input type="number" class="critical-counter" min="0" placeholder="0"><label><input type="checkbox"> 歴史</label></li><li><input type="text" class="custom-skill-input" placeholder="技能名を入力"><button class="add-skill-button">+</button></li></ul></div>
                <div class="skill-category"><h3>自由メモ欄</h3><textarea class="memo-area" placeholder="ここに自由にメモを記入できます"></textarea></div>`;
            
            const initialSheet = document.getElementById('char1');
            initialSheet.innerHTML = `<h2><div><span class="char-name" data-char-id="char1">探索者1</span>の技能</div><button class="reset-button">リセット</button></h2>` + templateHolder.innerHTML;
            
            initialSheet.querySelector('.reset-button').addEventListener('click', resetSheet);
            document.querySelector('.delete-tab-button').addEventListener('click', deleteSheet);
            
            document.getElementById('mode-toggle-button').addEventListener('click', toggleWideMode);
            document.getElementById('layout-toggle-button').addEventListener('click', toggleLayoutMode);
            document.getElementById('add-tab-button').addEventListener('click', addCharSheet);
            document.querySelector('.tab-buttons').addEventListener('dblclick', handleNameEdit);
            document.getElementById('copy-summary-button').addEventListener('click', copySummary);
            document.getElementById('sheets-container').addEventListener('click', (event) => {
                if (event.target.classList.contains('add-skill-button')) addCustomSkill(event);
            });
            document.getElementById('sheets-container').addEventListener('input', updateSummary);
            
            document.querySelector('.tab-link.active').click();
        }

        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>
